<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Music Suggestion Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg p-8 bg-gray-800 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center mb-2">Gemini Music AI Test</h1>
        <p class="text-gray-400 text-center mb-6">Test prompts to get song suggestions from the AI.</p>

        <div class="space-y-4">
            <div>
                <label for="mood-input" class="block text-sm font-medium text-gray-300 mb-1">Enter a Mood, Artist, or Song Title:</label>
                <input type="text" id="mood-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., happy, Taylor Swift - Dress...">
            </div>
            <button id="search-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                <span id="button-text">Ask AI for a Song</span>
                <div id="button-spinner" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-2">AI Response:</h2>
            <pre id="response-output" class="bg-gray-900 rounded-lg p-4 text-gray-300 whitespace-pre-wrap min-h-[100px]"></pre>
        </div>
    </div>

    <script>
        const searchBtn = document.getElementById('search-btn');
        const moodInput = document.getElementById('mood-input');
        const responseOutput = document.getElementById('response-output');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');

        // IMPORTANT: Paste your Gemini API Key here
        const geminiApiKey = "AIzaSyBvjsE7nitKmbjyGE69K3g_meK8Akonbyw";

        /**
         * A helper function to delay execution.
         * @param {number} ms - The number of milliseconds to wait.
         */
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * Fetches data from the Gemini API with exponential backoff for retries.
         * @param {object} payload - The data to send to the API.
         */
        async function fetchWithRetry(payload) {
            let attempt = 0;
            const maxAttempts = 5;
            let delay = 1000; // Start with a 1-second delay

            while (attempt < maxAttempts) {
                attempt++;
                try {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // If the server is overloaded (503), throw an error to trigger a retry.
                    if (response.status === 503) {
                        throw new Error("Server is overloaded (503)");
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                    }
                    
                    return await response.json(); // Success! Return the data.

                } catch (error) {
                    console.warn(`Attempt ${attempt} failed: ${error.message}`);
                    if (attempt >= maxAttempts) {
                        throw error; // Max retries reached, throw the final error.
                    }
                    responseOutput.textContent = `Server is busy. Retrying in ${delay / 1000}s... (Attempt ${attempt}/${maxAttempts})`;
                    await sleep(delay);
                    delay *= 2; // Double the delay for the next attempt.
                }
            }
        }


        searchBtn.addEventListener('click', async () => {
            const userInput = moodInput.value.trim();
            if (!userInput) {
                responseOutput.textContent = "Please enter a mood or idea.";
                return;
            }

            // Show loading state
            buttonText.classList.add('hidden');
            buttonSpinner.classList.remove('hidden');
            searchBtn.disabled = true;
            responseOutput.textContent = "Asking the AI...";

            try {
                // **FIXED:** New, smarter prompt logic
                const prompt = `You are a music recommender. Your task is to interpret the user's input.
                - If the user provides a specific artist and song title, your job is to simply return that exact "Artist - Song Title".
                - If the user provides a mood, genre, or general idea, your job is to suggest one specific, popular song that fits it.
                The user's input is: "${userInput}".`;
                
                const formatInstruction = "Respond with only the artist and song title in the format: Artist - Song Title.";
                
                const payload = {
                    contents: [{
                        parts: [{ text: `${prompt} ${formatInstruction}` }]
                    }]
                };

                const data = await fetchWithRetry(payload);
                
                if (data && data.candidates && data.candidates.length > 0) {
                    const text = data.candidates[0].content.parts[0].text.trim();
                    responseOutput.textContent = text;
                } else {
                    responseOutput.textContent = "The AI could not generate a response for this request. Try something else.";
                }

            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                responseOutput.textContent = `Error: ${error.message}`;
            } finally {
                // Hide loading state
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
                searchBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
